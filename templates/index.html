<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传服务</title>
    <script src="/static/tailwind.js"></script>
    <link href="/static/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF', // 你的自定义主色
                        secondary: '#0FC6C2',
                        neutral: '#F5F7FA',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        slideIn: {
                            'from': {transform: 'translateX(100%)', opacity: '0'},
                            'to': {transform: 'translateX(0)', opacity: '1'},
                        },
                        fadeOut: {
                            'from': {opacity: '1'},
                            'to': {opacity: '0'},
                        }
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s',
                        'fade-out': 'fadeOut 0.5s 2.5s',
                    },
                    spacing: {
                        'scroll-mt': '1.25rem',
                    },
                    scrollMargin: {
                        'file-list': '1.25rem',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            /* 原有样式保留 */
            .content-auto {
                content-visibility: auto;
            }

            .upload-progress {
                @apply h-2 bg-gray-200 rounded-full overflow-hidden;
            }

            .upload-progress-bar {
                @apply h-full bg-primary transition-all duration-300 ease-out;
            }

            .file-drop-zone {
                @apply border-2 border-dashed border-gray-300 rounded-lg p-8 text-center transition-all duration-300;
            }

            .file-drop-zone.active {
                @apply border-primary bg-primary/5;
            }

            .file-icon {
                @apply text-2xl mr-2;
            }

            .file-icon.pdf {
                @apply text-red-500;
            }

            .file-icon.img {
                @apply text-blue-500;
            }

            .file-icon.doc {
                @apply text-blue-400;
            }

            .file-icon.zip {
                @apply text-yellow-500;
            }

            .file-icon.other {
                @apply text-gray-500;
            }

            .toast {
                @apply fixed top-4 right-4 px-4 py-3 rounded-md shadow-lg z-50 animate-slide-in animate-fade-out;
            }

            /* 新增：二维码弹窗动画 */
            .modal-fade-in {
                animation: fadeIn 0.2s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            /* ========== 核心补全：固定表头+滚动容器样式 ========== */
            /* 滚动容器：固定高度+横向滚动+精简滚动条 */
            .file-table-container {
                @apply overflow-x-auto max-h-[70vh] scrollbar-thin;
            }

            /* 固定表头：粘性定位+防遮挡 */
            .sticky-table-header {
                @apply sticky top-0 bg-white z-10;
            }

            /* 锚点定位优化 */
            .file-list-section {
                @apply scroll-mt-5;
            }

            /* 精简滚动条（Firefox + Chrome/Safari） */
            .scrollbar-thin {
                scrollbar-width: thin; /* Firefox */
            }

            .scrollbar-thin::-webkit-scrollbar {
                width: 6px; /* Chrome/Safari */
            }

            .scrollbar-thin::-webkit-scrollbar-thumb {
                @apply bg-gray-300 rounded-full;
            }

            /* ========== 新增：二维码弹窗优化样式 ========== */
            .qrcode-modal-content {
                @apply max-w-3xl w-full mx-4 modal-fade-in;
            }

            .qrcode-carousel {
                @apply relative w-full flex items-center justify-center py-4;
            }

            .qrcode-img {
                @apply max-w-[80%] max-h-[60vh] w-auto h-auto object-contain border border-gray-200 rounded-lg;
            }

            .qrcode-nav-btn {
                @apply absolute top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-white/80 hover:bg-white shadow-md flex items-center justify-center text-gray-700 hover:text-primary transition-all;
            }

            .qrcode-nav-btn:disabled {
                @apply opacity-30 cursor-not-allowed hover:text-gray-700;
            }

            .qrcode-pagination {
                @apply mt-4 text-center text-gray-600 text-sm;
            }

            .qrcode-instructions {
                @apply mt-6 p-4 bg-neutral rounded-lg text-sm text-gray-700;
            }

            .qrcode-md5 {
                @apply mt-2 p-2 bg-gray-100 rounded-md font-mono text-xs break-all;
            }
        }
    </style>
</head>
<body>
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- 标题区域：微压间距（mb-8→mb-6，mt-2→mt-1） -->
    <header class="mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-gray-800 flex items-center">
                    <i class="fa fa-cloud-upload mr-3 text-primary"></i>
                    文件上传服务
                </h1>
                <p class="text-gray-600 mt-1">支持大文件上传和断点续传，最大文件大小: {{ formatSize .Max_file_size }}</p>
            </div>

            <!-- 新增：用户名和退出按钮 -->
            <div class="flex items-center gap-5">
                <div class="text-right border-l-2 border-gray-300 pl-5">
                    <div class="text-base text-gray-800 font-semibold flex items-center justify-end">
                        <i class="fa fa-user-circle mr-3 text-primary text-lg"></i>
                        {{.Username}}
                    </div>
                    <a href="/logout"
                       class="text-sm text-gray-600 hover:text-primary hover:underline mt-2 transition-colors inline-flex items-center justify-end group">
                        <i class="fa fa-sign-out mr-2 group-hover:translate-x-0.5 transition-transform"></i>
                        退出登录
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- 上传区域：微压间距（p-6→p-5，mb-8→mb-6；dropZone mb-6→mb-5，mt-3→mt-2） -->
    <section class="bg-white rounded-xl shadow-md p-5 mb-6">
        <div id="dropZone" class="file-drop-zone mb-5">
            <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-3"></i>
            <p class="text-gray-600 mb-2">拖放文件到此处上传</p>
            <p class="text-sm text-gray-500">或</p>
            <label class="inline-block mt-2">
                    <span class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-md cursor-pointer transition-all duration-300 flex items-center justify-center">
                        <i class="fa fa-file-o mr-2"></i> 选择文件
                        <input type="file" id="fileInput" class="hidden" multiple/>
                    </span>
            </label>
        </div>

        <!-- 上传进度区域：保留原有样式 -->
        <div id="uploadProgressContainer" class="hidden">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold">上传进度</h3>
                <button id="refreshBtn" class="text-sm text-primary hover:text-primary/80">
                    <i class="fa fa-refresh mr-1"></i> 刷新列表
                </button>
            </div>
            <div id="uploadItems" class="space-y-4"></div>
        </div>
    </section>

    <!-- 核心修改1：给文件列表区域添加锚点ID → fileListSection -->
    <section id="fileListSection" class="file-list-section bg-white rounded-xl shadow-md p-6">
        <div class="flex justify-between items-center mb-5">
            <div class="text-xl font-bold text-gray-800">
                <nav class="flex items-center space-x-2" aria-label="Breadcrumb">
                    <!-- 1. 根目录节点（固定：dirAbs，跳转至服务根目录） -->
                    <a href="/" class="text-primary hover:text-primary/80 transition-colors">
                        {{ .dirAbs }}
                    </a>

                    <!-- 2. 处理相对路径（dirRel）的多级节点 -->
                    {{ if .dirRel }}
                    <!-- 拆分相对路径为多级片段（处理开头/、空值、多级目录） -->
                    {{ $relParts := split (trimPrefix .dirRel "/") "/" }}
                    {{ $currentPath := "" }}

                    {{ range $index, $part := $relParts }}
                    {{ if $part }} <!-- 跳过空片段（比如路径末尾的/） -->
                    <!-- 拼接当前级的完整相对路径（用于跳转） -->
                    {{ $currentPath = printf "%s/%s" $currentPath $part }}
                    <!-- 分隔符（/） -->
                    <span class="text-gray-500">/</span>
                    <!-- 目录节点：最后一级不可点击，其余可点击 -->
                    {{ if eq $index (sub (len $relParts) 1) }}
                    <!-- 当前目录（最后一级）：不可点击 -->
                    <span class="text-gray-800">{{ $part }}</span>
                    {{ else }}
                    <!-- 非当前目录：可点击跳转 -->
                    <a href="/explore{{ $currentPath }}" class="text-primary hover:text-primary/80 transition-colors">
                        {{ $part }}
                    </a>
                    {{ end }}
                    {{ end }}
                    {{ end }}
                    {{ end }}
                </nav>
            </div>
            <!-- 新增：文件名搜索框 -->
            <div class="flex items-center gap-2">
                <input
                        type="text"
                        id="searchInput"
                        placeholder="搜索文件名..."
                        value="{{ .SearchKey }}"
                        class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary w-48"
                >
                <button
                        onclick="searchFiles()"
                        class="bg-primary text-white text-sm px-3 py-1 rounded-md hover:bg-primary/90 transition-colors flex items-center"
                >
                    <i class="fa fa-search mr-1"></i>搜索
                </button>
            </div>
        </div>

        <div id="fileListContainer">
            {{ if .Files }}
            <!-- 核心修改：添加滚动容器 + 固定表头样式 -->
            <!-- 文件列表表格（核心修正版） -->
            <div class="file-table-container" style="max-height: 70vh;">
                <!-- 1. 强制表格撑满容器 + 固定列宽 -->
                <table class="w-full table-fixed divide-y divide-gray-200">
                    <thead class="sticky-table-header"
                           style="position: sticky; top: 0; background: white; z-index: 10;">
                    <tr>
                        <!-- 2. 合理分配列宽（消除右侧空白） -->
                        <th class="w-[45%] px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            文件名
                        </th>
                        <th class="w-[10%] px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            大小
                        </th>
                        <th class="w-[20%] px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            上传时间
                        </th>
                        <th class="w-[25%] px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            操作
                        </th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    {{ range $file := .Files }}
                    <tr class="hover:bg-gray-50 transition-colors duration-200">
                        <td class="w-[45%] px-4 py-3 whitespace-nowrap">
                            <div class="flex items-center">
                                {{ if $file.IsDir }}
                                <i class="fa fa-folder-o mr-2 text-primary"></i>
                                {{ $targetPath := "" }}
                                {{ if $.dirRel }}
                                <!-- 多级目录拼接：/explore/xxx/bbb -->
                                {{ $targetPath = printf "/explore%s/%s" $.dirRel $file.Name }}
                                {{ else }}
                                <!-- 根目录拼接：/explore/bbb -->
                                {{ $targetPath = printf "/explore/%s" $file.Name }}
                                {{ end }}
                                <a href="{{ $targetPath }}"
                                   class="text-sm font-medium text-primary hover:text-primary/80 truncate max-w-xs transition-colors">
                                    {{ $file.Name }}
                                </a>
                                {{ else }}
                                <i class="fa {{ getFileIconClass $file.Name }} mr-2"></i>
                                <span class="text-sm font-medium text-gray-900 truncate max-w-xs">{{ $file.Name }}</span>
                                {{ end }}
                            </div>
                        </td>
                        <td class="w-[10%] px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                            {{ if $file.IsDir }}--{{ else }}{{ $file.Size }}{{ end }}
                        </td>
                        <td class="w-[20%] px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                            {{ $file.MTime | datetimeformat }}
                        </td>
                        <td class="w-[25%] px-4 py-3 whitespace-nowrap text-sm font-medium">
                            {{ if not $file.IsDir }}
                            <!-- 核心：定义文件完整路径（兼容多级目录） -->
                            {{ $fileFullPath := "" }}
                            {{ if $.dirRel }}
                            <!-- 多级目录：拼接 dirRel + 文件名（如 /xxx/yyy/a.txt） -->
                            {{ $fileFullPath = printf "%s/%s" $.dirRel $file.Name }}
                            {{ else }}
                            <!-- 根目录：直接用文件名（如 a.txt） -->
                            {{ $fileFullPath = $file.Name }}
                            {{ end }}
                            <!-- 清理路径中的多余/（比如//），避免路径错误 -->
                            {{ $fileFullPath = replace $fileFullPath "//" "/" }}

                            <!-- 预览按钮：拼接完整预览路径 -->
                            {{ if and (gt $file.SizeBytes 0) ($file.IsText) (le $file.SizeBytes 1048576) }}
                            <a href="/preview/{{ $fileFullPath }}"
                               class="text-secondary hover:text-secondary/80 mr-2 inline-block">
                                <i class="fa fa-eye mr-1"></i> 预览
                            </a>
                            {{ end }}

                            <!-- 二维码按钮：传递完整文件路径给JS -->
                            {{ if and (gt $file.SizeBytes 0) (lt $file.SizeBytes 10240) }}
                            <button onclick="generateQrcode('{{ $fileFullPath }}')"
                                    class="text-yellow-500 hover:text-yellow-600 mr-2 inline-block">
                                <i class="fa fa-qrcode mr-1"></i> 二维码
                            </button>
                            {{ end }}

                            <!-- 下载按钮：拼接完整下载路径 -->
                            <a href="/download/{{ $fileFullPath }}"
                               class="text-primary hover:text-primary/80 mr-2 inline-block">
                                <i class="fa fa-download mr-1"></i> 下载
                            </a>

                            <!-- 删除按钮：传递完整文件路径给JS -->
                            <button onclick="deleteFile('{{ $fileFullPath }}')"
                                    class="text-red-600 hover:text-red-800 inline-block">
                                <i class="fa fa-trash-o mr-1"></i> 删除
                            </button>
                            {{ end }}
                        </td>
                    </tr>
                    {{ end }}
                    </tbody>
                </table>
            </div>

            {{ else }}
            <div class="text-center py-12">
                <i class="fa fa-folder-open-o text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">暂无上传文件</p>
            </div>
            {{ end }}

            <!-- 分页控件：微压间距（mt-8→mt-6） + 核心修改2：所有分页链接添加锚点#fileListSection -->
            {{ if gt .TotalPage 1 }}
            <div class="mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                <!-- 分页信息 -->
                <div class="text-sm text-gray-600">
                    第 {{ .CurrentPage }} 页 / 共 {{ .TotalPage }} 页 | 总 {{ .Total }} 条记录
                </div>

                <!-- 分页按钮组：所有链接拼接#fileListSection锚点 -->
                <div class="flex items-center gap-2">
                    <!-- 首页 -->
                    <a href="?page=1&pageSize={{ .PageSize }}#fileListSection"
                       class="px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors {{ if eq .CurrentPage 1 }}opacity-50 cursor-not-allowed pointer-events-none{{ end }}">
                        <i class="fa fa-angle-double-left"></i>
                    </a>

                    <!-- 上一页 -->
                    <a href="?page={{ sub .CurrentPage 1 }}&pageSize={{ .PageSize }}#fileListSection"
                       class="px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors {{ if eq .CurrentPage 1 }}opacity-50 cursor-not-allowed pointer-events-none{{ end }}">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <!-- 页码数字 -->
                    {{ if gt .CurrentPage 2 }}
                    <a href="?page={{ sub .CurrentPage 2 }}&pageSize={{ .PageSize }}#fileListSection"
                       class="px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors">
                        {{ sub .CurrentPage 2 }}
                    </a>
                    {{ end }}

                    {{ if gt .CurrentPage 1 }}
                    <a href="?page={{ sub .CurrentPage 1 }}&pageSize={{ .PageSize }}#fileListSection"
                       class="px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors">
                        {{ sub .CurrentPage 1 }}
                    </a>
                    {{ end }}

                    <!-- 当前页 -->
                    <span class="px-3 py-2 rounded-md border border-primary bg-primary text-white">
                        {{ .CurrentPage }}
                    </span>

                    {{ if lt .CurrentPage .TotalPage }}
                    <a href="?page={{ add .CurrentPage 1 }}&pageSize={{ .PageSize }}#fileListSection"
                       class="px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors">
                        {{ add .CurrentPage 1 }}
                    </a>
                    {{ end }}

                    {{ if lt .CurrentPage (sub .TotalPage 1) }}
                    <a href="?page={{ add .CurrentPage 2 }}&pageSize={{ .PageSize }}#fileListSection"
                       class="px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors">
                        {{ add .CurrentPage 2 }}
                    </a>
                    {{ end }}

                    <!-- 下一页 -->
                    <a href="?page={{ add .CurrentPage 1 }}&pageSize={{ .PageSize }}#fileListSection"
                       class="px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors {{ if eq .CurrentPage .TotalPage }}opacity-50 cursor-not-allowed pointer-events-none{{ end }}">
                        <i class="fa fa-angle-right"></i>
                    </a>

                    <!-- 尾页 -->
                    <a href="?page={{ .TotalPage }}&pageSize={{ .PageSize }}#fileListSection"
                       class="px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors {{ if eq .CurrentPage .TotalPage }}opacity-50 cursor-not-allowed pointer-events-none{{ end }}">
                        <i class="fa fa-angle-double-right"></i>
                    </a>

                    <!-- 每页条数选择：onchange事件添加锚点#fileListSection -->
                    <select onchange="window.location.href='?page=1&pageSize='+this.value+'#fileListSection'"
                            class="ml-2 px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
                        <option value="10" {{ if eq .PageSize 10 }}selected{{ end }}>10条/页</option>
                        <option value="20" {{ if eq .PageSize 20 }}selected{{ end }}>20条/页</option>
                        <option value="50" {{ if eq .PageSize 50 }}selected{{ end }}>50条/页</option>
                    </select>
                </div>
            </div>
            {{ end }}
        </div>
    </section>

    <!-- ========== 重构：二维码弹窗（大尺寸+轮播+操作说明） ========== -->
    <div id="qrcodeModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="qrcode-modal-content bg-white rounded-xl shadow-xl p-8">
            <!-- 弹窗头部 -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">文件二维码</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fa fa-times text-lg"></i>
                </button>
            </div>

            <!-- 二维码轮播区域 -->
            <div id="qrcodeContainer" class="w-full">
                <!-- 加载状态 -->
                <div class="flex flex-col items-center justify-center py-12 text-gray-500">
                    <svg class="w-8 h-8 animate-spin mb-3" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor"
                              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-sm">正在生成二维码...</p>
                </div>
            </div>

            <!-- 操作说明区域（默认隐藏，获取数据后显示） -->
            <div id="qrcodeInstructions" class="qrcode-instructions hidden">
                <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
                    <i class="fa fa-info-circle mr-2 text-primary"></i>操作指引
                </h4>
                <ul class="list-disc list-inside space-y-1 mb-3 text-gray-700">
                    <li>使用微信/支付宝等扫码工具，<b>按顺序扫描所有分片二维码</b></li>
                    <li>将每个二维码识别到的文本内容<b>按顺序拼接</b>，得到完整文件内容</li>
                    <li>拼接完成后，可通过MD5校验值验证文件完整性</li>
                </ul>
                <div id="base64Tips" class="hidden mt-2 text-orange-600 text-sm bg-orange-50 p-2 rounded">
                    <i class="fa fa-exclamation-triangle mr-1"></i>
                    该文件为Base64编码的二进制文件：请将拼接后的文本通过Base64解码工具还原为原始文件
                </div>
                <div class="mt-2">
                    <span class="text-xs text-gray-500">文件MD5校验值：</span>
                    <div id="fileMd5" class="qrcode-md5">加载中...</div>
                </div>
            </div>

            <!-- 弹窗底部 -->
            <div class="flex justify-end mt-6">
                <button id="closeModalBtn"
                        class="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-800 transition-colors">
                    关闭
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // 文件类型图标映射
    const fileTypeIcons = {
        'pdf': 'fa-file-pdf-o',
        'doc': 'fa-file-word-o',
        'docx': 'fa-file-word-o',
        'xls': 'fa-file-excel-o',
        'xlsx': 'fa-file-excel-o',
        'ppt': 'fa-file-powerpoint-o',
        'pptx': 'fa-file-powerpoint-o',
        'jpg': 'fa-file-image-o',
        'jpeg': 'fa-file-image-o',
        'png': 'fa-file-image-o',
        'gif': 'fa-file-image-o',
        'bmp': 'fa-file-image-o',
        'webp': 'fa-file-image-o',
        'zip': 'fa-file-archive-o',
        'rar': 'fa-file-archive-o',
        '7z': 'fa-file-archive-o',
        'txt': 'fa-file-text-o',
        'default': 'fa-file-o'
    };

    // 获取文件图标类
    function getFileIconClass(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        return fileTypeIcons[ext] || fileTypeIcons['default'];
    }

    // 显示Toast通知
    function showToast(message, type = 'success') {
        const colors = {
            success: 'bg-green-500 text-white',
            error: 'bg-red-500 text-white',
            warning: 'bg-yellow-500 text-black',
            info: 'bg-blue-500 text-white'
        };

        const toast = document.createElement('div');
        toast.className = `toast ${colors[type]}`;
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="fa ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'} mr-2"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function searchFiles() {
        const searchKey = document.getElementById('searchInput').value.trim();
        const urlParams = new URLSearchParams(window.location.search);
        // 核心修正：搜索时强制重置为第1页，仅保留每页条数（pageSize）
        const page = '1'; // 全局搜索默认从第1页开始
        const pageSize = urlParams.get('pageSize') || '10'; // 保留用户选择的每页条数

        // 构造URL：重置page=1，保留pageSize，追加搜索关键词
        let newUrl = window.location.pathname + `?page=${page}&pageSize=${pageSize}`;
        if (searchKey) {
            newUrl += `&search=${encodeURIComponent(searchKey)}`;
        }
        // 锚点定位到文件列表
        newUrl += '#fileListSection';

        window.location.href = newUrl;
    }

    // 回车触发搜索（保留）
    document.getElementById('searchInput').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            searchFiles();
        }
    });

    // ========== 核心重构：二维码相关逻辑 ==========
    let currentFetchAbortController = null;
    // 二维码分片数据存储
    let qrcodeChunks = [];
    let currentQrcodeIndex = 0;
    let fileMd5Value = '';
    let isBase64File = false;

    // 生成二维码逻辑（参数改为filePath：文件相对路径）
    function generateQrcode(filePath) {
        // 1. 校验路径参数
        if (!filePath || filePath.trim() === '') {
            alert('请选择有效的文件路径！');
            return;
        }

        // 2. 重置状态
        qrcodeChunks = [];
        currentQrcodeIndex = 0;
        fileMd5Value = '';
        isBase64File = false;

        // 3. 显示弹窗，初始化加载状态
        const modal = document.getElementById('qrcodeModal');
        const container = document.getElementById('qrcodeContainer');
        const instructions = document.getElementById('qrcodeInstructions');

        modal.classList.remove('hidden');
        instructions.classList.add('hidden'); // 隐藏说明，加载完成后显示
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-gray-500">
                <svg class="w-8 h-8 animate-spin mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-sm">正在生成二维码...</p>
            </div>
        `;

        // 4. 取消之前未完成的请求（避免重复加载）
        if (currentFetchAbortController) {
            currentFetchAbortController.abort();
        }
        currentFetchAbortController = new AbortController();
        const signal = currentFetchAbortController.signal;

        // 5. 处理路径编码（避免特殊字符/斜杠导致请求错误）
        const encodedPath = encodeURIComponent(filePath);
        const requestUrl = `/qrcode/${encodedPath}`;

        // 6. 发起后端请求
        fetch(requestUrl, {
            method: 'GET',
            signal: signal, // 绑定取消信号
            headers: {
                'Accept': 'application/json', // 明确要求JSON响应
            }
        })
            .then(res => {
                // 细化HTTP状态码错误处理
                if (!res.ok) {
                    return res.json().then(errData => {
                        throw new Error(errData.error || `请求失败（状态码：${res.status}）`);
                    }).catch(() => {
                        throw new Error(`请求失败（状态码：${res.status}）`);
                    });
                }
                return res.json();
            })
            .then(data => {
                // 清空取消控制器
                currentFetchAbortController = null;

                // 存储MD5值和Base64标识
                fileMd5Value = data.md5 || data.MD5 || '';
                isBase64File = data.isBase64 || data.IsBase64 || false;

                // 校验chunks格式，避免空/错误数据
                if (!Array.isArray(data.chunks) || data.chunks.length === 0) {
                    container.innerHTML = `
                        <div class="text-gray-500 text-sm text-center py-12">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                            <p class="text-lg">暂无二维码分片数据</p>
                        </div>
                    `;
                    return;
                }

                // 存储分片数据并初始化显示
                qrcodeChunks = data.chunks.map(chunk => ({
                    index: chunk.index || chunk.Index || 0,
                    total: chunk.total || chunk.Total || data.chunks.length,
                    qrCodePNG: chunk.qrCodePNG || chunk.QRCodePNG || '',
                    isBase64: chunk.isBase64 || chunk.IsBase64 || false
                })).filter(chunk => chunk.qrCodePNG); // 过滤无效分片

                if (qrcodeChunks.length === 0) {
                    container.innerHTML = `
                        <div class="text-gray-500 text-sm text-center py-12">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-lg">二维码数据无效，请重试</p>
                        </div>
                    `;
                    return;
                }

                // 渲染二维码轮播
                renderQrcodeCarousel();

                // 显示操作说明
                document.getElementById('qrcodeInstructions').classList.remove('hidden');
                document.getElementById('fileMd5').textContent = fileMd5Value || '未获取到MD5值';
                document.getElementById('base64Tips').classList.toggle('hidden', !isBase64File);
            })
            .catch(err => {
                // 排除“请求取消”的错误（用户重复点击时的正常取消）
                if (err.name !== 'AbortError') {
                    container.innerHTML = `
                        <div class="text-red-500 text-sm text-center py-12">
                            <svg class="w-12 h-12 mx-auto mb-4 text-red-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-lg">生成二维码失败</p>
                            <p class="mt-2 text-sm text-gray-500">${err.message || '请稍后重试'}</p>
                        </div>
                    `;
                }
                // 清空取消控制器
                currentFetchAbortController = null;
            });
    }

    // 渲染二维码轮播
    function renderQrcodeCarousel() {
        const container = document.getElementById('qrcodeContainer');
        const currentChunk = qrcodeChunks[currentQrcodeIndex];

        container.innerHTML = `
            <div class="qrcode-carousel">
                <!-- 上一页按钮 -->
                <button class="qrcode-nav-btn left-4" onclick="changeQrcode(-1)" ${currentQrcodeIndex === 0 ? 'disabled' : ''}>
                    <i class="fa fa-chevron-left"></i>
                </button>

                <!-- 二维码图片 -->
                <img
                    src="${currentChunk.qrCodePNG}"
                    alt="文件分片 ${currentChunk.index}/${currentChunk.total} 二维码"
                    class="qrcode-img"
                    onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0icm91bmQiIHN0cm9rZT0icm91bmQiIHN0cm9rZS13aWR0aD0iMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgYWxpZ25tZW50LWJhc2VsaW5lPSJtaWRkbGUiPuWbvueJhzE8L3RleHQ+PC9zdmc+';"
                >

                <!-- 下一页按钮 -->
                <button class="qrcode-nav-btn right-4" onclick="changeQrcode(1)" ${currentQrcodeIndex === qrcodeChunks.length - 1 ? 'disabled' : ''}>
                    <i class="fa fa-chevron-right"></i>
                </button>
            </div>
            <div class="qrcode-pagination">
                分片 ${currentQrcodeIndex + 1} / ${qrcodeChunks.length}
                <span class="ml-2 text-gray-500 text-xs">
                    ${currentChunk.isBase64 ? 'Base64编码' : '纯文本'}
                </span>
            </div>
        `;
    }

    // 切换二维码分片
    function changeQrcode(direction) {
        const newIndex = currentQrcodeIndex + direction;
        if (newIndex >= 0 && newIndex < qrcodeChunks.length) {
            currentQrcodeIndex = newIndex;
            renderQrcodeCarousel();
        }
    }

    // 关闭弹窗（优化：统一逻辑，避免重复代码）
    function closeQrcodeModal() {
        const modal = document.getElementById('qrcodeModal');
        modal.classList.add('hidden');

        // 重置状态
        qrcodeChunks = [];
        currentQrcodeIndex = 0;
        fileMd5Value = '';
        isBase64File = false;

        // 清空容器
        document.getElementById('qrcodeContainer').innerHTML = '';
        document.getElementById('qrcodeInstructions').classList.add('hidden');

        // 取消未完成的请求
        if (currentFetchAbortController) {
            currentFetchAbortController.abort();
            currentFetchAbortController = null;
        }
    }

    // 绑定关闭事件（统一调用closeQrcodeModal）
    document.getElementById('closeModal')?.addEventListener('click', closeQrcodeModal);
    document.getElementById('closeModalBtn')?.addEventListener('click', closeQrcodeModal);
    document.getElementById('qrcodeModal')?.addEventListener('click', (e) => {
        if (e.target === document.getElementById('qrcodeModal')) {
            closeQrcodeModal();
        }
    });
    document.addEventListener('keydown', (e) => {
        const modal = document.getElementById('qrcodeModal');
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeQrcodeModal();
        }
    });

    // 上传相关功能
    document.addEventListener('DOMContentLoaded', function () {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const uploadProgressContainer = document.getElementById('uploadProgressContainer');
            const uploadItems = document.getElementById('uploadItems');
            const refreshBtn = document.getElementById('refreshBtn');
            // 存储当前上传任务
            const uploadQueue = {};
            // 兼容后端未配置的情况，默认0表示不限制
            const maxFileSize = parseInt('{{ .Max_file_size }}') || 0;
            const rawDirRel = '{{ .dirRel }}' || '';
            const normalizedDirRel = rawDirRel.replace(/\/+/g, '/').replace(/\/$/, '').replace(/^\//, '');
            let uploadPathPrefix = '/upload';
            let resumeInfoPathPrefix = '/get_resume_info';
            if (normalizedDirRel) {
                // 拆分路径分段，仅编码每个分段（避免编码/）
                const pathSegments = normalizedDirRel.split('/');
                const encodedSegments = pathSegments.map(seg => encodeURIComponent(seg));
                const encodedDirPath = encodedSegments.join('/'); // 用/拼接编码后的分段
                uploadPathPrefix = `/upload/${encodedDirPath}`;
                resumeInfoPathPrefix = `/get_resume_info/${encodedDirPath}`;
            }

            // 刷新文件列表
            refreshBtn.addEventListener('click', function () {
                location.reload();
            });

            // 拖放事件
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropZone.classList.add('active');
            }

            function unhighlight() {
                dropZone.classList.remove('active');
            }

            // 处理文件拖放
            dropZone.addEventListener('drop', handleDrop, false);


            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            // 获取续传信息
            function getResumeInfo(fileName) {
                return fetch(`${resumeInfoPathPrefix}?file_name=${encodeURIComponent(fileName)}`)
                    .then(response => response.json());
            }

            // 处理文件选择
            fileInput.addEventListener('change', function () {
                handleFiles(this.files);
            });


            // 处理文件上传
            function handleFiles(files) {
                if (files.length === 0) return;

                uploadProgressContainer.classList.remove('hidden');
                uploadItems.innerHTML = '';

                Array.from(files).forEach(file => {
                    // 仅当maxFileSize>0时才做限制（0表示不限制）
                    if (maxFileSize > 0 && file.size > maxFileSize) {
                        // 提示用户：显示友好的大小单位（如MB/GB）
                        showToast(
                            `文件 "${file.name}" 大小超过限制（最大支持${formatSize(maxFileSize)}，当前文件${formatSize(file.size)}），无法上传`,
                            'error'
                        );
                        return; // 跳过该文件，不加入上传队列
                    }

                    // 使用文件名作为唯一标识
                    const fileKey = file.name;
                    const fileSize = file.size;

                    // 如果文件已在队列中，跳过
                    if (uploadQueue[fileKey]) return;

                    uploadQueue[fileKey] = {
                        file,
                        fileName: file.name,
                        fileKey,
                        status: 'pending', // pending, checking, waiting, uploading, paused, cancelled, completed
                        uploadedChunks: 0,
                        resolve: null,
                        reject: null,
                        fileSize
                    };

                    // 开始处理
                    processUpload(fileKey);
                });
            }

            // 创建上传进度UI
            function createUploadProgressUI(file) {
                const itemId = `upload-${file.name.replace(/[^a-z0-9]/gi, '-')}`;
                const actionsId = `upload-actions-${file.name.replace(/[^a-z0-9]/gi, '-')}`;
                const uploadItem = document.createElement('div');
                uploadItem.id = itemId;
                uploadItem.className = 'border border-gray-200 rounded-lg p-4';
                uploadItem.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center truncate">
                        <i class="fa ${getFileIconClass(file.name)} file-icon mr-3"></i>
                        <div>
                            <div class="font-medium truncate max-w-xs">${file.name}</div>
                            <div class="upload-status text-gray-500 text-xs">准备中...</div>
                        </div>
                    </div>
                    <div class="upload-size text-xs text-gray-500">0/${formatSize(file.size)}</div>
                </div>
                <!-- 新增：进度信息行（速度、耗时、剩余时间） -->
                <div class="upload-metrics text-xs text-gray-500 mb-2">
                    <span class="upload-speed">速度：0 MB/s</span> |
                    <span class="upload-elapsed">耗时：00:00</span> |
                    <span class="upload-remaining">剩余：--:--</span>
                </div>
                <div class="upload-progress">
                    <div class="upload-progress-bar" style="width: 0%"></div>
                </div>
                <div id="${actionsId}" class="flex justify-end mt-3 space-x-2">
                    <button class="pause-btn text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">
                        <i class="fa fa-pause"></i> 暂停
                    </button>
                    <button class="cancel-btn text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">
                        <i class="fa fa-times"></i> 取消
                    </button>
                </div>
            `;
                uploadItems.appendChild(uploadItem);
                const speedElement = uploadItem.querySelector('.upload-speed');
                const elapsedElement = uploadItem.querySelector('.upload-elapsed');
                const remainingElement = uploadItem.querySelector('.upload-remaining');
                return {
                    item: uploadItem,
                    actionsId: actionsId,
                    fileName: file.name,
                    fileSize: file.size,
                    speedElement: speedElement,
                    elapsedElement: elapsedElement,
                    remainingElement: remainingElement
                };
            }

            // 格式化时间（秒转 分:秒 格式）
            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return '--:--';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            // 处理上传流程
            async function processUpload(fileKey) {
                const item = uploadQueue[fileKey];
                if (!item) return;

                item.status = 'checking';
                const chunkSize = parseInt('{{ .Chunk_size }}');
                const isSmallFile = item.fileSize <= chunkSize;

                try {
                    // 1. 检查文件是否存在
                    const checkResult = await getResumeInfo(item.fileName);

                    if (checkResult.file_exists) {
                        // 文件存在，等待用户选择
                        item.status = 'waiting';
                        const userChoice = await showConfirmDialog(item.fileName, isSmallFile);

                        if (userChoice === 'cancel') {
                            delete uploadQueue[fileKey];
                            removeUploadItem(item.fileName);
                            return;
                        }


                        // 映射用户选择到action参数
                        if (userChoice === 'resume') {

                            item.uploadedChunks = checkResult.uploaded_chunks || 0;
                            item.action = 'resume';  // 新增：设置续传标识
                        } else if (userChoice === 'replace') {
                            item.uploadedChunks = 0; // 覆盖从头开始
                            item.action = 'overwrite'; // 新增：设置覆盖标识
                        }
                    } else {
                        item.uploadedChunks = 0; // 新文件从头开始
                        item.action = 'new'; // 新增：设置新文件标识
                    }

                    // 2. 开始实际上传
                    item.status = 'uploading';
                    await startUploadProcess(item);

                    // 3. 上传完成
                    item.status = 'completed';
                    showToast(`"${item.fileName}" 上传成功`, 'success');

                } catch (error) {
                    // 检查错误消息，避免显示不必要的错误
                    if (error.message === '上传已暂停' || error.message === '上传已取消') {
                        // 不显示toast，只在控制台记录
                        console.log(`"${item.fileName}" ${error.message}`);
                        item.status = error.message === '上传已暂停' ? 'paused' : 'cancelled';
                    } else if (error !== 'cancelled' && error.message !== 'cancelled') {
                        console.error("上传错误:", error);
                        showToast(`"${item.fileName}" 上传失败: ${error.message}`, 'error');
                        item.status = 'error';
                    }
                } finally {
                    // 上传完成3秒后清理
                    setTimeout(() => {
                        delete uploadQueue[fileKey];
                    }, 6000);
                }
            }

            // 开始实际上传
            async function startUploadProcess(item) {
                const {file, fileName, uploadedChunks = 0} = item;

                // 创建上传进度UI
                const uploadInfo = createUploadProgressUI(file);
                const progressBar = uploadInfo.item.querySelector('.upload-progress-bar');
                const statusText = uploadInfo.item.querySelector('.upload-status');
                const sizeText = uploadInfo.item.querySelector('.upload-size');
                const pauseBtn = uploadInfo.item.querySelector('.pause-btn');
                const cancelBtn = uploadInfo.item.querySelector('.cancel-btn');
                // 新增：性能监控变量
                let startTime = Date.now(); // 上传开始时间
                let totalElapsed = 0; // 总耗时（秒）
                let avgSpeed = 0; // 平均上传速度（MB/s）
                let avgChunkTime = 0; // 平均每个分片的上传耗时（秒）
                let pauseStartTime = 0; // 暂停开始的时间戳
                let pausedTotalTime = 0; // 累计暂停的总时长（秒）

                // 设置分块大小
                const chunkSize = parseInt('{{ .Chunk_size }}'); // 确保转换为数字
                console.log(chunkSize);
                const totalChunks = Math.ceil(file.size / chunkSize);
                console.log(totalChunks);
                let currentChunk = uploadedChunks;
                let isPaused = false;
                let controller = new AbortController();
                let uploadAborted = false;

                // 更新进度显示
                const updateProgress = () => {
                    const percent = Math.round((currentChunk / totalChunks) * 100);
                    progressBar.style.width = `${percent}%`;
                    const uploadedSize = Math.min(currentChunk * chunkSize, file.size);
                    sizeText.textContent = `${formatSize(uploadedSize)}/${formatSize(file.size)}`;

                    // 仅在已传完至少1个分片时计算（避免除以0）
                    if (currentChunk > 0 && !isPaused && !uploadAborted) {
                        // 计算总耗时
                        totalElapsed = (Date.now() - startTime) / 1000 - pausedTotalTime;

                        // 计算平均速度：已传总大小(MB) / 总耗时(秒)
                        const uploadedSizeMB = uploadedSize / (1024 * 1024);
                        avgSpeed = uploadedSizeMB / totalElapsed;

                        // 计算平均每个分片的耗时（秒/块）
                        avgChunkTime = totalElapsed / currentChunk;

                        // 预计剩余时间：剩余块数 × 平均单块耗时（无需精准，简化计算）
                        const remainingChunks = totalChunks - currentChunk;
                        const remainingTime = remainingChunks * avgChunkTime;

                        // 更新UI（保留2位小数，时间转分:秒格式）
                        uploadInfo.speedElement.textContent = `速度：${avgSpeed.toFixed(2)} MB/s`;
                        uploadInfo.elapsedElement.textContent = `耗时：${formatTime(totalElapsed)}`;
                        uploadInfo.remainingElement.textContent = `剩余：${formatTime(remainingTime)}`;
                    }

                    if (currentChunk === totalChunks && !isPaused && !uploadAborted) {
                        statusText.textContent = '上传完成';
                        statusText.className = 'text-green-500 text-xs';
                        const actionsContainer = document.getElementById(uploadInfo.actionsId);
                        if (actionsContainer) actionsContainer.remove();

                        setTimeout(() => {
                            uploadInfo.item.style.opacity = '0';
                            uploadInfo.item.style.transition = 'opacity 0.5s ease';
                            setTimeout(() => {
                                uploadInfo.item.remove();
                            }, 500);
                        }, 3000);
                    }

                };

                // 初始进度更新
                updateProgress();
                statusText.textContent = uploadedChunks > 0
                    ? `续传中 (${currentChunk}/${totalChunks})`
                    : `上传中 (${currentChunk}/${totalChunks})`;

                // 按钮事件
                pauseBtn.onclick = () => {
                    isPaused = !isPaused;
                    pauseBtn.innerHTML = isPaused
                        ? '<i class="fa fa-play"></i> 继续'
                        : '<i class="fa fa-pause"></i> 暂停';
                    if (isPaused) {
                        statusText.textContent = `上传已暂停 (${currentChunk}/${totalChunks})`;
                        statusText.className = 'text-yellow-500 text-xs';
                        uploadInfo.speedElement.textContent = `速度：-- MB/s`;
                        uploadInfo.remainingElement.textContent = `剩余：--:--`;
                        pauseStartTime = Date.now();
                    } else {
                        statusText.className = 'text-gray-500 text-xs';
                        // 1. 计算本次暂停的时长，并累加至总暂停时长
                        if (pauseStartTime > 0) {
                            const pauseDuration = (Date.now() - pauseStartTime) / 1000;
                            pausedTotalTime += pauseDuration;
                            pauseStartTime = 0; // 重置暂停开始时间
                        }
                        updateProgress();
                        uploadNextChunk();

                    }
                };

                cancelBtn.onclick = () => {
                    // 标记为已取消
                    item.status = 'cancelled';
                    // 中止请求
                    if (controller) {
                        controller.abort();
                    }
                    delete uploadQueue[item.fileKey];

                    // UI 过渡移除
                    uploadInfo.item.style.opacity = '0';
                    uploadInfo.item.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => {
                        if (uploadInfo.item && uploadInfo.item.parentNode) {
                            uploadInfo.item.remove();
                        }
                    }, 300);

                    statusText.textContent = '上传已取消';
                    statusText.className = 'text-red-500 text-xs';
                    // 不再抛出错误，而是直接处理取消逻辑
                    // 同时更新上传项的状态，让后续流程知道已取消
                    return;
                };

                // 上传分块
                const uploadNextChunk = async () => {
                    while (currentChunk < totalChunks && !isPaused && !uploadAborted) {
                        let start = currentChunk * chunkSize;
                        let end = Math.min(start + chunkSize, file.size);
                        let chunk = file.slice(start, end);

                        // 更新UI：补充分片索引的精准提示
                        statusText.textContent = `上传中 (${currentChunk + 1}/${totalChunks})`;

                        try {
                            const formData = new FormData();
                            formData.append('file', chunk);
                            formData.append('file_name', fileName);
                            formData.append('chunk_index', currentChunk);
                            formData.append('total_chunks', totalChunks);
                            formData.append('action', item.action || 'new');

                            const response = await fetch(uploadPathPrefix, {
                                method: 'POST',
                                body: formData,
                                signal: controller.signal,
                                // 补充：请求头优化
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });
                            const data = await response.json();

                            if (data.status !== 'success') {
                                throw new Error(data.message || `分片 ${currentChunk + 1}/${totalChunks} 上传失败`);
                            }

                            currentChunk++;
                            updateProgress();

                            // 补充：手动释放chunk引用，触发GC回收
                            chunk = null;
                        } catch (error) {
                            // 补充：区分取消错误和其他错误
                            if (error.name === 'AbortError' || error.message === '上传已取消') {
                                // 补充：用户主动取消的提示
                                statusText.textContent = '上传已取消';
                                statusText.className = 'text-red-500 text-xs';

                                // 不再抛出错误，直接返回
                                return Promise.reject(new Error('上传已取消'));
                            } else {
                                // 补充：精细化错误提示
                                statusText.textContent = `分片 ${currentChunk + 1}/${totalChunks} 上传错误: ${error.message}`;
                                statusText.className = 'text-red-500 text-xs';

                                // 补充：失败重试机制（指数退避）
                                const retryCount = item.retryCount || 0;
                                if (retryCount < 3) {
                                    item.retryCount = retryCount + 1;
                                    statusText.textContent = `重试中 (${item.retryCount}/3)...`;
                                    setTimeout(() => uploadNextChunk(), 1000 * item.retryCount); // 1s、2s、3s 递增重试
                                    return; // 避免throw，重试优先
                                }
                                return Promise.reject(error); // 重试3次失败后再抛出
                            }
                        }

                    }

                    // 继续上传下一块
                    if (currentChunk >= totalChunks && !isPaused && !uploadAborted) {
                        // 补充：上传完成的UI处理
                        statusText.textContent = '上传完成';
                        statusText.className = 'text-green-500 text-xs';
                        // 可选：隐藏/删除上传项，或清理按钮
                        setTimeout(() => {
                            uploadInfo.item.style.opacity = '0';
                            setTimeout(() => uploadInfo.item.remove(), 500);
                        }, 3000);
                    }
                };


                // 开始上传
                await uploadNextChunk();
                // ========== 新增：校验是否真的上传完成 ==========
                if (currentChunk < totalChunks) {
                    // 未传完所有分片（暂停/取消），抛出错误阻止成功提示
                    throw new Error(isPaused ? '上传已暂停' : '上传已取消');
                }
            }

            // 删除上传项
            function removeUploadItem(fileName) {
                const itemId = `upload-${fileName.replace(/[^a-z0-9]/gi, '-')}`;
                const item = document.getElementById(itemId);
                if (item) item.remove();
            }

            // 显示确认对话框（返回Promise）
            function showConfirmDialog(fileName, isSmallFile = true) {
                return new Promise((resolve) => {
                    const dialog = document.createElement('div');
                    dialog.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                    const showResumeButton = !isSmallFile;

                    dialog.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-xl font-bold text-gray-800 mb-4">文件已存在</h3>
                <p class="text-gray-600 mb-6">文件 "${fileName}" 已存在，您想如何处理？</p>
                <div class="flex justify-end space-x-3">
                    <button class="cancel-btn px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        取消
                    </button>
                    <button class="replace-btn px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">
                        覆盖
                    </button>
                    ${showResumeButton ? `
                    <button class="resume-btn px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90">
                        续传
                    </button>
                    ` : ''}
                </div>
            </div>
        `;
// 点击背景关闭
                    dialog.onclick = (e) => {
                        if (e.target === dialog) {
                            document.body.removeChild(dialog);
                            resolve('cancel');
                        }
                    };
                    // 获取按钮元素
                    const cancelBtn = dialog.querySelector('.cancel-btn');
                    const replaceBtn = dialog.querySelector('.replace-btn');
                    const resumeBtn = dialog.querySelector('.resume-btn'); // 可能为 null

                    // 设置事件处理
                    cancelBtn.onclick = () => {
                        document.body.removeChild(dialog);
                        resolve('cancel');
                    };

                    replaceBtn.onclick = () => {
                        document.body.removeChild(dialog);
                        resolve('replace');
                    };

                    // 只在续传按钮存在时设置事件
                    if (resumeBtn) {
                        resumeBtn.onclick = () => {
                            document.body.removeChild(dialog);
                            resolve('resume');
                        };
                    }

                    document.body.appendChild(dialog);
                });
            }

            // 删除文件
            window.deleteFile = function (fileFullPath) {
                // 保留原始路径用于友好提示（不编码）
                const originalPath = fileFullPath;
                // 对完整路径做URL编码（处理空格、中文、特殊字符等）
                const encodedPath = encodeURIComponent(fileFullPath);

                if (confirm(`确定要删除文件 "${originalPath}" 吗？`)) {
                    fetch(`/delete/${encodedPath}`, {
                        method: 'DELETE'
                    })
                        .then(response => {
                            // 兼容后端可能返回非JSON的情况（比如500错误）
                            if (!response.ok) {
                                throw new Error(`HTTP错误，状态码：${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success') {
                                showToast('文件已删除', 'success');
                                // 重新加载页面
                                setTimeout(() => {
                                    location.reload();
                                }, 1500);
                            } else {
                                showToast(`删除失败: ${data.message}`, 'error');
                            }
                        })
                        .catch(error => {
                            showToast(`删除错误: ${error.message}`, 'error');
                        });
                }
            };

            // 格式化文件大小
            function formatSize(bytes) {
                if (bytes === 0) return '0 B';

                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(1024));

                return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + units[i];
            }
        }
    );

</script>

</body>
</html>